<!DOCTYPE html>
<html>
<head>
    <title>keepOrSweep</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",getSettingsFields:function(){return[{name:"toDate",xtype:"rallydatefield",fieldLabel:"Ignore artifacts created on or after:",value:new Date}]},myApp:null,THEME_COLOR_1:"#4E1E1E",THEME_COLOR_2:"#58E481",THEME_COLOR_3:"#E63870",THEME_COLOR_4:"#FBE6A2",itemBacklog:[],conversationPostModel:null,launch:function(){myApp=this,Rally.data.ModelFactory.getModel({type:"ConversationPost",success:myApp.launchPage,scope:myApp})},launchPage:function(model){myApp.conversationPostModel=model,myApp.clearContent(),myApp.add({xtype:"label",html:"It's time to review your backlog and vote to keep ... or sweep. You'll be presented with each item under consideration and asked whether we should keep it on the backlog or sweep it into the recycle bin. Your choices are tracked as comments on the artifact for later action.<br/>",style:{"font-size":"15px"}}),myApp.add({xtype:"rallybutton",itemId:"beginButton",text:"Start Voting!",handler:function(){myApp.beginButtonHandler()},style:{"background-color":myApp.THEME_COLOR_1,"border-color":myApp.THEME_COLOR_1}})},beginButtonHandler:function(){myApp._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Loading... Please wait."}),myApp._myMask.show(),myApp.loadItems("Defect")},loadItems:function(model){var filters=[];if(myApp.getSetting("toDate")){var toDateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"CreationDate",operator:"<",value:new Date(myApp.getSetting("toDate"))});filters.push(toDateFilter)}var scheduleStateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"ScheduleState",operator:"<=",value:"Defined"});filters.push(scheduleStateFilter);var store=Ext.create("Rally.data.wsapi.Store",{model:model,fetch:["Discussion","FormattedID","Name","CreationDate","Description"],context:myApp.getContext().getDataContext(),pageSize:2e3,limit:2e3},myApp);store.addFilter(filters,!1),store.loadPage(1,{scope:myApp,callback:function(records,operation){operation.wasSuccessful()&&(myApp.itemBacklog=_.union(myApp.itemBacklog,_.pluck(records,"data")),"Defect"==model?myApp.loadItems("UserStory"):(console.log(myApp.itemBacklog),myApp._myMask.hide(),myApp.presentItem(0)))}})},presentItem:function(itemIndex){if(myApp.clearContent(),itemIndex<myApp.itemBacklog.length-1){var item=myApp.itemBacklog[itemIndex];myApp.add({xtype:"label",html:"Item "+(itemIndex+1)+" of "+myApp.itemBacklog.length+"</br></br>",style:{"font-size":"15px"}}),myApp.add({xtype:"rallybutton",itemId:"keepButton",text:"Keep",handler:function(){myApp.processItem(itemIndex,!0)},style:{"background-color":myApp.THEME_COLOR_2,"border-color":myApp.THEME_COLOR_2}}),myApp.add({xtype:"rallybutton",itemId:"sweepButton",text:"Sweep",handler:function(){myApp.processItem(itemIndex,!1)},style:{"background-color":myApp.THEME_COLOR_3,"border-color":myApp.THEME_COLOR_3}}),myApp.add({xtype:"rallybutton",itemId:"skipButton",text:"Skip",handler:function(){myApp.presentItem(itemIndex+1)},style:{"background-color":myApp.THEME_COLOR_4,"border-color":myApp.THEME_COLOR_4,"font-color":myApp.THEME_COLOR_3}}),myApp.add({xtype:"label",html:"<br/><br/><u><b>ID</b></u><br/>",style:{"font-size":"15px",color:myApp.THEME_COLOR_1}}),myApp.add({xtype:"label",html:item.FormattedID,style:{"font-size":"15px"}}),myApp.add({xtype:"label",html:"<br/><br/><u><b>Name</b></u><br/>",style:{"font-size":"15px",color:myApp.THEME_COLOR_1}}),myApp.add({xtype:"label",html:item.Name,style:{"font-size":"15px"}}),myApp.add({xtype:"label",html:"<br/><br/><u><b>Creation Date</b></u><br/>",style:{"font-size":"15px",color:myApp.THEME_COLOR_1}}),myApp.add({xtype:"label",html:item.CreationDate.toLocaleString("en-US"),style:{"font-size":"15px"}}),myApp.add({xtype:"label",html:"<br/><br/><u><b>Description</b></u><br/>",style:{"font-size":"15px",color:myApp.THEME_COLOR_1}}),myApp.add({xtype:"label",html:item.Description,style:{"font-size":"15px"}})}else myApp.add({xtype:"label",html:"It's Over!",style:{"font-size":"15px",color:myApp.THEME_COLOR_1}})},processItem:function(itemIndex,keep){var item=myApp.itemBacklog[itemIndex];myApp._myMask.show();var post=Ext.create(myApp.conversationPostModel,{Text:(keep?"Keep it!":"Sweep it!")+"<br/>Powered by the Keep-or-Sweep app",Artifact:item._ref});console.log(post),post.save({callback:function(result,operation){operation.wasSuccessful()&&(myApp._myMask.hide(),myApp.presentItem(itemIndex+1))}})},clearContent:function(){for(;myApp.down("label");)myApp.down("label").destroy();for(;myApp.down("button");)myApp.down("button").destroy();for(;myApp.down("rallygrid");)myApp.down("rallygrid").destroy();for(;myApp.down("textareafield");)myApp.down("textareafield").destroy()}});

            Rally.launchApp('CustomApp', {
                name:"keepOrSweep",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
